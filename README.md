# FemGRL:FEM-based graph residual learning


## Overview
The open-source Python package FemGRL is a numerical program for solving 2-D optical scattering problems. The program use the inherent consistency between GNN and FEM in data structure, the mesh generated by FEM is mapped into a graph structure.The program is able to compute complex single metal scatterer structures and further generalized to scenarios involving multiple metal scatterers using transfer learning manner.

If you find FemGRL useful for your research, please consider giving a star. Thank you.

## Usage
### Scripts
1. `build_graph`: Constructs graph datasets.
2. `model`: Constructs the network architecture.
3. `trainddp`: Network training module.
4. `config`:Configuration file; sets data loading paths, save locations, preprocessing options, etc.
5. `run`:Invokes the training code, configures the DDP environment, and enables multi-GPU parallelism.

## Data type
**Global Simulation Settings:**
- **Incident Field:** Plane wave defined as $E_{inc} = [1, 0, 0]e^{i(k_0 x \cos\theta + k_0 y \sin\theta)}$.
- **Center Position ($c_x, c_y$):** Randomly sampled within the range $[-500, 500]$ nm.

---

### 1. Basic Lossless Scatterers

This dataset consists of 5 basic geometric shapes defined by parameters $L_1$, $L_2$, and $L_3$.

![Basic Lossless Scatterers](<Basic lossless scatterers.png>)
*(a) Circle, (b) Ellipse, (c) Rectangle, (d) Trapezoid, (e) Cross*

#### Training Data
* **Total Samples:** 7,424 
* **Incident Angles ($\theta$):** 8 directions $[0^\circ, 45^\circ, 90^\circ, 135^\circ, 180^\circ, 225^\circ, 270^\circ, 315^\circ]$ 

| Shape | Geometry Parameters (nm) | Sampling Strategy | Count |
| :--- | :--- | :--- | :--- |
| **(a)** | $L_1 \in [300:60:600]$ | 16 pos combinations | 768  |
| **(b)** | $L_1 \in [360:80:640]$, $L_2 \in [400:100:700]$ | 16 pos combinations | 2,048  |
| **(c)** | $L_1 \in [360:80:650]$, $L_2 \in [400:150:700]$ | 16 pos combinations | 1,536  |
| **(d)** | $L_1 \in [320:80:600]$, $L_2 \in [350:100:650]$, $L_3 \in [400:100:600]$ | 4 pos combinations | 1,536  |
| **(e)** | $L_2 \in [350:100:650]$, $L_1 \in [0.4L_2:0.15L_2:0.7L_2]$ | 16 pos combinations | 1,536 |

#### Generalization (Test) Data
A separate set for testing generalization with distinct parameter ranges and specific angles.
* **Total Samples:** 88
* **Configurations:** Includes specific continuous ranges (e.g., $L_1 \in [200, 800]$ nm) and single incident angles per shape (e.g., $\theta=0^\circ$ for Circle).

---

### 2. Single Metal Scatterers

This dataset focuses on complex metallic structures with multi-branched geometries.

![Single Metal Scatterers](<Single metal scatterers.png>)
*(a-g) Various branched metal structures*

#### Training Data
* **Total Samples:** 8,448 
* **Incident Angles ($\theta$):** 8 directions $[0^\circ, \dots, 315^\circ]$ 
* **Positioning:** 16 random center positions ($c_x, c_y$) per configuration.

| Shape | Parameter Configuration (nm) | Count |
| :--- | :--- | :--- |
| **(a)** | $L_1=[160:50:310]$, $L_2=[60:20:100]$ | 1,152 |
| **(b)** | $L_1=[160:75:310]$, $L_2=80$, $L_3=90$, $L_4=[100:50:200]$ | 1,152 |
| **(c)** | $L_1=[160:75:310]$, $L_2=80$, $L_3=120$, $L_4=[100:50:200]$ | 1,536 |
| **(d)** | $L_1=[160:75:310]$, $L_2=80$, $L_3=90$, $L_4=[100:50:200]$ | 1,152 |
| **(e)** | $L_1=[160:75:310]$, $L_2=80$, $L_3=120$, $L_4=[100:50:200]$ | 1,152 |
| **(f)** | $L_1=[160:75:310]$, $L_2=80$, $L_3=90$, $L_4=[100:50:200]$ | 1,152 |
| **(g)** | $L_1=[160:75:310]$, $L_2=80$, $L_3=120$, $L_4=[100:50:200]$ | 1,152 |

#### Generalization (Test) Data
* **Total Samples:** 112 
* **Configurations:** Testing on continuous parameter ranges (e.g., $L_1=[110, 360]$) with specific fixed angles for each shape.

---

### 3. Multiple Metal Scatterers (Transfer Learning)

Datasets designed for transfer learning tasks involving multiple interacting scatterers.

![Multiple Metal Scatterers](<Transfer learning on Multiple metal scatterers.png>)
*(a) Configuration 1, (b) Configuration 2*

#### Dataset Specifications
* **Total Samples:** 3,456
* **Incident Angles:** 8 directions.

**Augmentation & Variations:**
1.  **Rotation:** Each scatterer is randomly rotated around its center in the range $[0^\circ, 360^\circ]$ (2 values sampled).
2.  **Scaling:** Each scatterer is randomly scaled in the range $[0.8, 1.2]$ (3 values sampled).

**Scenarios:**
* **Scenario (a):** Based on Shape B(2) parameters ($L_1=320, L_2=80, L_3=90, L_4=200$) .
* **Scenario (b):** Based on Shape B(5) parameters ($L_1=320, L_2=80, L_3=120, L_4=200$) .
